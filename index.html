<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>„Ç™„Éº„ÉÄ„Éº„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
            color: #333;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100vw;
            padding: 5px;
            min-height: 100vh;
        }

        /* „Çø„ÉñÂàá„ÇäÊõø„Åà */
        .tab-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            position: sticky;
            top: 0;
            background: #f5f0e8;
            padding: 5px 0;
            z-index: 100;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #e0d8cc;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(139, 115, 85, 0.3);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Ë®≠ÂÆö„Éö„Éº„Ç∏ */
        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0d8cc;
        }

        /* Ë°®ÂΩ¢Âºè„ÅÆË®≠ÂÆö„ÉÜ„Éº„Éñ„É´ */
        .settings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .settings-table th {
            background: #f5f0e8;
            padding: 10px 5px;
            text-align: center;
            font-weight: bold;
            color: #666;
            border: 1px solid #e0d8cc;
            font-size: 12px;
        }

        .settings-table td {
            padding: 8px 5px;
            border: 1px solid #e0d8cc;
            text-align: center;
        }

        .settings-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-table input[type="number"],
        .settings-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .settings-table input[type="text"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .custom-input-row {
            background: #f9f9f9;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #e0d8cc;
            color: #666;
        }

        .btn-danger {
            background: #d9534f;
            color: white;
        }

        /* Order„Éö„Éº„Ç∏ */
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .order-header .btn {
            padding: 8px 16px;
            font-size: 14px;
            margin: 0;
        }

        .room-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0d8cc;
            flex-wrap: wrap;
            gap: 8px;
        }

        .room-name {
            font-size: 18px;
            font-weight: bold;
            color: #8b7355;
        }

        .room-info {
            font-size: 13px;
            color: #666;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .eating-speed-badge {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
        }

        .eating-speed-badge:active {
            transform: scale(0.95);
        }

        .special-icons {
            display: flex;
            gap: 6px;
        }

        .special-icon {
            background: #fff3cd;
            color: #856404;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .course-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .course-table th {
            background: #f8f8f8;
            padding: 6px 4px;
            text-align: center;
            font-weight: bold;
            color: #666;
            border-bottom: 2px solid #e0d8cc;
            font-size: 11px;
        }

        .course-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .course-name {
            text-align: left;
            font-weight: bold;
            color: #333;
            position: relative;
        }

        .allergy-tag {
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 6px;
            font-weight: bold;
        }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éú„Çø„É≥ */
        .status-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 3px solid #ddd;
            background: white;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .status-btn:active {
            transform: scale(0.9);
        }

        .status-btn.none {
            color: #999;
            border-color: #ddd;
        }

        .status-btn.waiting {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .status-btn.ordered {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .status-btn.served {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .time-cell {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .time-cell:hover {
            background: #f0f0f0;
        }

        .staff-cell {
            font-size: 12px;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .staff-cell:hover {
            background: #f0f0f0;
        }

        .w-count-cell {
            font-size: 13px;
            font-weight: bold;
            color: #d9534f;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .w-count-cell:hover {
            background: #f0f0f0;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .modal-btn {
            padding: 15px;
            border: 2px solid #8b7355;
            border-radius: 10px;
            background: white;
            color: #8b7355;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:active {
            background: #8b7355;
            color: white;
            transform: scale(0.95);
        }

        .staff-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .allergy-modal-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .allergy-input-group {
            margin-bottom: 15px;
        }

        .allergy-input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .allergy-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* ËøΩÂä†ÊñôÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ */
        .additional-dish-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #e0d8cc;
        }

        .additional-dish-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .additional-dish-title {
            font-size: 14px;
            font-weight: bold;
            color: #8b7355;
        }

        .add-dish-btn {
            padding: 6px 12px;
            background: #8b7355;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .dish-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .dish-input-row input[type="text"] {
            flex: 2;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .dish-input-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .dish-input-row input[type="text"]:last-of-type {
            flex: 3;
        }

        .delete-dish-btn {
            padding: 6px 10px;
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        /* „Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÈÉ®Â±ãÂÖ•ÂäõË°å */
        .custom-room-input {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .custom-room-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .custom-room-input button {
            padding: 8px 16px;
            background: #8b7355;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        /* „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çπ„Çø„ÉÉ„Éï */
        .custom-staff-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #e0d8cc;
        }

        .custom-staff-input {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .custom-staff-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .custom-staff-input button {
            padding: 10px 20px;
            background: #8b7355;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .custom-staff-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .custom-staff-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0d8cc;
        }

        .custom-staff-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .custom-staff-item span {
            flex: 1;
            font-size: 13px;
        }

        .custom-staff-item button {
            padding: 4px 8px;
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
        @media (max-width: 768px) and (orientation: portrait) {
            .course-table {
                font-size: 12px;
            }
            
            .course-table th {
                padding: 5px 2px;
                font-size: 10px;
            }
            
            .course-table td {
                padding: 5px 2px;
            }
            
            .status-btn {
                width: 38px;
                height: 38px;
                font-size: 13px;
            }
            
            .room-name {
                font-size: 16px;
            }
            
            .room-info {
                font-size: 12px;
            }
        }

        @media (max-width: 820px) and (orientation: portrait) {
            .status-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
                border-width: 2.5px;
            }
            
            .time-cell {
                font-size: 13px;
            }
            
            .staff-cell {
                font-size: 11px;
            }
            
            .w-count-cell {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('index')">Index</button>
            <button class="tab-btn" onclick="switchTab('order')">Order</button>
        </div>

        <!-- Index Page -->
        <div id="index-page" class="page active">
            <div class="section">
                <div class="section-title">ÈÉ®Â±ãË®≠ÂÆö</div>
                <table class="settings-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">‰ΩøÁî®</th>
                            <th style="width: 100px;">ÈÉ®Â±ãÂêç</th>
                            <th style="width: 60px;">‰∫∫Êï∞</th>
                            <th style="width: 120px;">„Éó„É©„É≥</th>
                            <th style="width: 80px;">ÈñãÂßãÊôÇÂàª</th>
                            <th style="width: 80px;">„Ç¢„É¨„É´„ÇÆ„Éº</th>
                            <th style="width: 60px;">üéÇ</th>
                            <th style="width: 60px;">üçΩÔ∏è</th>
                            <th>„É°„É¢</th>
                        </tr>
                    </thead>
                    <tbody id="room-settings-table"></tbody>
                </table>
                
                <!-- „Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÈÉ®Â±ãËøΩÂä† -->
                <div style="margin-top: 15px;">
                    <div class="custom-room-input">
                        <input type="text" id="custom-room-name" placeholder="Êñ∞„Åó„ÅÑÈÉ®Â±ãÂêç" style="flex: 1;">
                        <button onclick="addCustomRoom()">ÈÉ®Â±ã„ÇíËøΩÂä†</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">„Çπ„Çø„ÉÉ„ÉïË®≠ÂÆö</div>
                <table class="settings-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">‰ΩøÁî®</th>
                            <th>„Çπ„Çø„ÉÉ„ÉïÂêç</th>
                        </tr>
                    </thead>
                    <tbody id="staff-settings-table"></tbody>
                </table>
                
                <!-- „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çπ„Çø„ÉÉ„ÉïËøΩÂä† -->
                <div class="custom-staff-section">
                    <div style="font-size: 14px; font-weight: bold; color: #8b7355; margin-bottom: 10px;">
                        „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çπ„Çø„ÉÉ„Éï
                    </div>
                    <div class="custom-staff-input">
                        <input type="text" id="custom-staff-input" placeholder="Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„ÉïÂêç">
                        <button onclick="addCustomStaff()">ËøΩÂä†</button>
                    </div>
                    <div class="custom-staff-list" id="custom-staff-list"></div>
                </div>
            </div>

            <div class="section">
                <div class="additional-dish-section">
                    <div class="additional-dish-header">
                        <div class="additional-dish-title">ËøΩÂä†ÊñôÁêÜ</div>
                        <button class="add-dish-btn" onclick="addDish()">Ôºã ÊñôÁêÜ„ÇíËøΩÂä†</button>
                    </div>
                    <div id="additional-dishes-list"></div>
                </div>
            </div>

            <div style="text-align: center; padding: 20px;">
                <button class="btn btn-primary" onclick="saveSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Å¶Order„Å∏</button>
                <button class="btn btn-secondary" onclick="resetSettings()">ÂàùÊúüÂåñ</button>
            </div>
        </div>

        <!-- Order Page -->
        <div id="order-page" class="page">
            <div class="order-header">
                <button class="btn btn-secondary" onclick="undoLastAction()">‚Ü© Undo</button>
                <button class="btn btn-danger" onclick="resetOrderState()">üîÑ Reset</button>
            </div>
            <div id="order-content"></div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div id="modal" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div id="modal-title" class="modal-title"></div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyAoyApbQzAlSYsM1MBDPZ68I5EaJ3M_yE8",
            authDomain: "restaurant-order-system-8855a.firebaseapp.com",
            databaseURL: "https://restaurant-order-system-8855a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "restaurant-order-system-8855a",
            storageBucket: "restaurant-order-system-8855a.firebasestorage.app",
            messagingSenderId: "695114713080",
            appId: "1:695114713080:web:de13ca2e7e448e92fb380d"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
    </script>

    <script>
        // „Éá„Éº„ÇøÊßãÈÄ†
        const FIXED_ROOMS = ['„ÇÑ„Åæ„Å∂„Åç', '„Å™„Åß„Åó„Åì', '„Å§„Å∞„Åç', '„ÇÑ„Åó„Åä', '„Åï„Åè„Çâ', '„Åµ„Åò', '„Åï„Å§„Åç', '„Åç„Åô„Åí', '„ÇÜ„Çä', '„ÅØ„Åé'];
        const FIXED_STAFF = ['ÁúüÂºì', '„Éü„É≥„Ç∞„Éû', '„Éú„Éì„Éº', '„Çµ„É©„Éü', '„Éë„Éì', 'ÁøîÂπ≥'];
        
        const PLANS = {
            '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ': ['Âê∏Áâ©', 'ÊûúËèúÁõõ„Çä', 'Ëí∏Áâ©', 'ÊèöÁâ©', 'ÁÖÆÁâ©', '„ÅîÈ£Ø', 'ÁîòÂë≥'],
            'ÂíåÁâõÊáêÁü≥': ['Âê∏Áâ©', 'ÊûúËèúÁõõ„Çä', '„Åô„ÅçÁÑº„Åç', '„Éï„É©„Ç§', '„Çπ„ÉÜ„Éº„Ç≠', '„ÅîÈ£Ø', 'ÁîòÂë≥'],
            '„Çπ„ÉÜ„Éº„Ç≠': ['Âê∏Áâ©', 'ÊûúËèúÁõõ„Çä', 'Ëí∏Áâ©', 'ÊèöÁâ©', '„Çπ„ÉÜ„Éº„Ç≠', '„ÅîÈ£Ø', 'ÁîòÂë≥'],
            '„Åó„ÇÉ„Å∂„Åó„ÇÉ„Å∂': ['Âê∏Áâ©', 'ÊûúËèúÁõõ„Çä', '„Åó„ÇÉ„Å∂„Åó„ÇÉ„Å∂', 'Ëí∏Áâ©', 'ÊèöÁâ©', '„ÅîÈ£Ø', 'ÁîòÂë≥'],
            'ÈÄ£Ê≥ä': ['Ëå∂Á¢óËí∏„Åó', 'Áâõ„Åü„Åü„Åç', 'ÁÑºÁâ©', 'Â∞èÈâ¢', 'ÊèöÁâ©', '„ÅîÈ£Ø', 'ÁîòÂë≥']
        };

        let settings = {
            rooms: [],
            staff: [],
            additionalDishes: [],
            customRooms: [],
            customStaff: []
        };

        let orderState = {};
        let lastAction = null;

        const EATING_SPEEDS = ['VF', 'F', 'LF', 'N', 'LS', 'S', 'VS'];

        // ÂàùÊúüÂåñ
        function init() {
            loadSettings();
            renderIndexPage();
            renderOrderPage();
        }

        // Ë®≠ÂÆöË™≠„ÅøËæº„Åø
        function loadSettings() {
            const saved = localStorage.getItem('orderSettings');
            if (saved) {
                settings = JSON.parse(saved);
                // Âè§„ÅÑ„Éá„Éº„Çø„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ
                if (!settings.customRooms) settings.customRooms = [];
                if (!settings.customStaff) settings.customStaff = [];
            } else {
                // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                settings = {
                    rooms: FIXED_ROOMS.map(name => ({
                        name: name,
                        enabled: true,
                        people: 2,
                        time: '18:00',
                        plan: '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ',
                        memo: '',
                        allergies: {},
                        hasCake: false,
                        hasPlate: false,
                        isCustom: false
                    })),
                    staff: FIXED_STAFF.map(name => ({ name: name, enabled: true, isCustom: false })),
                    additionalDishes: [],
                    customRooms: [],
                    customStaff: []
                };
            }

            const savedOrder = localStorage.getItem('orderState');
            if (savedOrder) {
                orderState = JSON.parse(savedOrder);
            }
        }

        // Ë®≠ÂÆö‰øùÂ≠ò
        function saveSettings() {
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            initOrderState();
            saveOrderState();
            switchTab('order');
            alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü!');
        }

        // Ë®≠ÂÆö„ÇíÈùô„Åã„Å´‰øùÂ≠ò(„Ç¢„É©„Éº„Éà„ÇÑ„Çø„ÉñÂàá„ÇäÊõø„Åà„Å™„Åó)
        function saveSettingsQuiet() {
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            initOrderState();
            saveOrderState();
        }

        // Ë®≠ÂÆöÂàùÊúüÂåñ
        function resetSettings() {
            if (!confirm('ÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åô„Åã?\n(ÈÉ®Â±ã„Éª„Çπ„Çø„ÉÉ„Éï„ÅØÂÖ®ÈÅ∏Êäû„ÄÅ‰∫∫Êï∞2Âêç„ÄÅÊôÇÈñì18:00„ÄÅ„Éó„É©„É≥„ÅØ„Çπ„Çø„É≥„ÉÄ„Éº„Éâ„Å´„Å™„Çä„Åæ„Åô)')) {
                return;
            }
            
            settings = {
                rooms: FIXED_ROOMS.map(name => ({
                    name: name,
                    enabled: true,
                    people: 2,
                    time: '18:00',
                    plan: '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ',
                    memo: '',
                    allergies: {},
                    hasCake: false,
                    hasPlate: false,
                    isCustom: false
                })),
                staff: FIXED_STAFF.map(name => ({ name: name, enabled: true, isCustom: false })),
                additionalDishes: [],
                customRooms: [],
                customStaff: []
            };
            
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            renderIndexPage();
            alert('ÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü!');
        }

        // OrderÁä∂ÊÖãÂàùÊúüÂåñ
        function initOrderState() {
            orderState = {};
            const allRooms = [...settings.rooms.filter(r => r.enabled), ...settings.customRooms.filter(r => r.enabled)];
            
            allRooms.forEach(room => {
                const courses = PLANS[room.plan];
                orderState[room.name] = {
                    eatingSpeed: 'N',
                    courses: {}
                };
                
                // ÈÄöÂ∏∏„ÅÆÊñôÁêÜ
                courses.forEach(course => {
                    orderState[room.name].courses[course] = {
                        status: 'none',
                        time: null,
                        pressedTime: null,
                        staff: null,
                        wCount: 0
                    };
                });
                
                // ËøΩÂä†ÊñôÁêÜ
                const roomIndex = room.isCustom ? 
                    'custom-' + settings.customRooms.indexOf(room) : 
                    String(settings.rooms.indexOf(room));  // ÊñáÂ≠óÂàó„Å´Â§âÊèõ!
                
                settings.additionalDishes.forEach(dish => {
                    if (dish.rooms.includes(roomIndex)) {
                        orderState[room.name].courses[dish.name] = {
                            status: 'none',
                            time: null,
                            pressedTime: null,
                            staff: null,
                            wCount: 0
                        };
                    }
                });
            });
        }

        // OrderÁä∂ÊÖã‰øùÂ≠ò (Firebase„Å´ÂêåÊúü)
        function saveOrderState() {
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem('orderState', JSON.stringify(orderState));
            
            // Firebase„Å´‰øùÂ≠ò
            if (window.firebaseDB && window.firebaseRef && window.firebaseSet) {
                const ordersRef = window.firebaseRef(window.firebaseDB, 'orders');
                window.firebaseSet(ordersRef, orderState).catch(error => {
                    console.error('Firebase‰øùÂ≠ò„Ç®„É©„Éº:', error);
                });
            }
        }

        // Ë®≠ÂÆö„Éö„Éº„Ç∏„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderIndexPage() {
            // ÈÉ®Â±ãË®≠ÂÆö„ÉÜ„Éº„Éñ„É´
            const tableBody = document.getElementById('room-settings-table');
            tableBody.innerHTML = '';
            
            // ÂÖ®„Å¶„ÅÆÈÉ®Â±ã(Âõ∫ÂÆöÔºã„Ç´„Çπ„Çø„É†)
            const allRooms = [...settings.rooms, ...settings.customRooms];
            
            allRooms.forEach((room, index) => {
                const tr = document.createElement('tr');
                if (room.isCustom) tr.className = 'custom-input-row';
                
                const isCustomRoom = room.isCustom;
                const actualIndex = isCustomRoom ? 
                    settings.rooms.length + settings.customRooms.indexOf(room) : 
                    settings.rooms.indexOf(room);
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" ${room.enabled ? 'checked' : ''} 
                               onchange="${isCustomRoom ? `toggleCustomRoom(${settings.customRooms.indexOf(room)})` : `toggleRoom(${actualIndex})`}">
                    </td>
                    <td>
                        ${isCustomRoom ? 
                            `<input type="text" value="${room.name}" onchange="updateCustomRoomName(${settings.customRooms.indexOf(room)}, this.value)" placeholder="ÈÉ®Â±ãÂêç">` : 
                            room.name
                        }
                        ${isCustomRoom ? 
                            `<br><button class="delete-room-btn" style="margin-top: 5px; padding: 4px 8px; font-size: 11px;" onclick="deleteCustomRoom(${settings.customRooms.indexOf(room)})">ÂâäÈô§</button>` : 
                            ''
                        }
                    </td>
                    <td>
                        <input type="number" min="1" max="10" value="${room.people}" 
                               onchange="${isCustomRoom ? `updateCustomRoomPeople(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomPeople(${actualIndex}, this.value)`}">
                    </td>
                    <td>
                        <select onchange="${isCustomRoom ? `updateCustomRoomPlan(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomPlan(${actualIndex}, this.value)`}">
                            ${Object.keys(PLANS).map(p => 
                                `<option value="${p}" ${room.plan === p ? 'selected' : ''}>${p}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="${isCustomRoom ? `updateCustomRoomTime(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomTime(${actualIndex}, this.value)`}">
                            ${generateTimeOptions(room.time)}
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px; margin: 0;" 
                                onclick="showAllergyModal(${isCustomRoom ? settings.customRooms.indexOf(room) : actualIndex}, ${isCustomRoom})">
                            Ë®≠ÂÆö
                        </button>
                    </td>
                    <td>
                        <input type="checkbox" ${room.hasCake ? 'checked' : ''} 
                               onchange="${isCustomRoom ? `updateCustomRoomCake(${settings.customRooms.indexOf(room)}, this.checked)` : `updateRoomCake(${actualIndex}, this.checked)`}">
                    </td>
                    <td>
                        <input type="checkbox" ${room.hasPlate ? 'checked' : ''} 
                               onchange="${isCustomRoom ? `updateCustomRoomPlate(${settings.customRooms.indexOf(room)}, this.checked)` : `updateRoomPlate(${actualIndex}, this.checked)`}">
                    </td>
                    <td>
                        <input type="text" value="${room.memo || ''}" placeholder="„É°„É¢" 
                               onchange="${isCustomRoom ? `updateCustomRoomMemo(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomMemo(${actualIndex}, this.value)`}">
                    </td>
                `;
                
                tableBody.appendChild(tr);
            });

            // „Çπ„Çø„ÉÉ„ÉïË®≠ÂÆö„ÉÜ„Éº„Éñ„É´
            const staffTableBody = document.getElementById('staff-settings-table');
            staffTableBody.innerHTML = '';
            
            settings.staff.forEach((staff, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" ${staff.enabled ? 'checked' : ''} onchange="toggleStaff(${index})">
                    </td>
                    <td>${staff.name}</td>
                `;
                staffTableBody.appendChild(tr);
            });

            // „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çπ„Çø„ÉÉ„Éï„É™„Çπ„Éà
            const customStaffList = document.getElementById('custom-staff-list');
            customStaffList.innerHTML = '';
            
            settings.customStaff.forEach((staff, index) => {
                const div = document.createElement('div');
                div.className = 'custom-staff-item';
                div.innerHTML = `
                    <input type="checkbox" ${staff.enabled ? 'checked' : ''} onchange="toggleCustomStaff(${index})">
                    <span>${staff.name}</span>
                    <button onclick="deleteCustomStaff(${index})">ÂâäÈô§</button>
                `;
                customStaffList.appendChild(div);
            });

            // ËøΩÂä†ÊñôÁêÜ„É™„Çπ„Éà
            const dishesList = document.getElementById('additional-dishes-list');
            dishesList.innerHTML = '';
            
            settings.additionalDishes.forEach((dish, index) => {
                const div = document.createElement('div');
                div.className = 'dish-input-row';
                div.innerHTML = `
                    <input type="text" value="${dish.name}" onchange="updateDishName(${index}, this.value)" placeholder="ÊñôÁêÜÂêç">
                    <select onchange="updateDishPosition(${index}, this.value)">
                        <option value="before" ${dish.position === 'before' ? 'selected' : ''}>„ÅîÈ£Ø„ÅÆÂâç</option>
                        <option value="after" ${dish.position === 'after' ? 'selected' : ''}>„ÅîÈ£Ø„ÅÆÂæå</option>
                    </select>
                    <input type="text" value="${dish.rooms.join(',')}" onchange="updateDishRooms(${index}, this.value)" placeholder="ÈÉ®Â±ãÁï™Âè∑(„Ç´„É≥„ÉûÂå∫Âàá„Çä)">
                    <button class="delete-dish-btn" onclick="deleteDish(${index})">ÂâäÈô§</button>
                `;
                dishesList.appendChild(div);
            });
        }

        // ÊôÇÈñìÈÅ∏ÊäûËÇ¢ÁîüÊàê
        function generateTimeOptions(selectedTime) {
            const options = [];
            for (let h = 17; h <= 23; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    options.push(`<option value="${time}" ${time === selectedTime ? 'selected' : ''}>${time}</option>`);
                }
            }
            return options.join('');
        }

        // Order„Éö„Éº„Ç∏„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderOrderPage() {
            const content = document.getElementById('order-content');
            content.innerHTML = '';
            
            const allRooms = [...settings.rooms.filter(r => r.enabled), ...settings.customRooms.filter(r => r.enabled)];
            
            allRooms.forEach(room => {
                if (!orderState[room.name]) {
                    orderState[room.name] = { eatingSpeed: 'N', courses: {} };
                }

                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                
                const eatingSpeed = orderState[room.name].eatingSpeed || 'N';
                
                const specialIcons = [];
                if (room.hasCake) specialIcons.push('<span class="special-icon">üéÇ</span>');
                if (room.hasPlate) specialIcons.push('<span class="special-icon">üçΩÔ∏è</span>');
                
                roomCard.innerHTML = `
                    <div class="room-header">
                        <div class="room-name">${room.name}</div>
                        <div class="room-info">
                            <span>${room.people}Âêç</span>
                            <span>${room.time}„Äú</span>
                            <span>${room.plan}</span>
                            ${room.memo ? `<span style="color: #d9534f;">üìù ${room.memo}</span>` : ''}
                            <div class="eating-speed-badge" onclick="showEatingSpeedModal('${room.name}')">
                                ${eatingSpeed}
                            </div>
                            ${specialIcons.length > 0 ? `<div class="special-icons">${specialIcons.join('')}</div>` : ''}
                        </div>
                    </div>
                `;
                
                const table = document.createElement('table');
                table.className = 'course-table';
                
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th style="width: 120px;">ÊñôÁêÜ</th>
                            <th style="width: 60px;">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                            <th style="width: 70px;">Êèê‰æõÊôÇÂàª</th>
                            <th style="width: 60px;">„Çπ„Çø„ÉÉ„Éï</th>
                            <th style="width: 50px;">WÊï∞</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                const courses = PLANS[room.plan];
                
                // ÈÄöÂ∏∏„ÅÆÊñôÁêÜ
                courses.forEach(course => {
                    if (!orderState[room.name].courses[course]) {
                        orderState[room.name].courses[course] = {
                            status: 'none',
                            time: null,
                            pressedTime: null,
                            staff: null,
                            wCount: 0
                        };
                    }
                    
                    const state = orderState[room.name].courses[course];
                    const allergy = room.allergies[course];
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="course-name">
                            ${course}
                            ${allergy ? `<span class="allergy-tag">${allergy}</span>` : ''}
                        </td>
                        <td>
                            <button class="status-btn ${state.status}" onclick="toggleStatus('${room.name}', '${course}')">
                                ${getStatusText(state.status)}
                            </button>
                        </td>
                        <td class="time-cell" onclick="showTimeModal('${room.name}', '${course}')">
                            ${state.time || '-'}
                        </td>
                        <td class="staff-cell" onclick="showStaffModal('${room.name}', '${course}')">
                            ${state.staff || '-'}
                        </td>
                        <td class="w-count-cell" onclick="showWCountModal('${room.name}', '${course}')">
                            ${state.wCount > 0 ? `W√ó${state.wCount}` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // ËøΩÂä†ÊñôÁêÜ(„ÅîÈ£Ø„ÅÆÂâç)
                const roomIndex = room.isCustom ? 
                    'custom-' + settings.customRooms.indexOf(room) : 
                    String(settings.rooms.indexOf(room));
                
                const beforeDishes = settings.additionalDishes.filter(d => 
                    d.position === 'before' && d.rooms.includes(roomIndex)
                );
                
                beforeDishes.forEach(dish => {
                    if (!orderState[room.name].courses[dish.name]) {
                        orderState[room.name].courses[dish.name] = {
                            status: 'none',
                            time: null,
                            pressedTime: null,
                            staff: null,
                            wCount: 0
                        };
                    }
                    
                    const state = orderState[room.name].courses[dish.name];
                    const tr = document.createElement('tr');
                    tr.style.background = '#fffbf0';
                    tr.innerHTML = `
                        <td class="course-name">${dish.name}</td>
                        <td>
                            <button class="status-btn ${state.status}" onclick="toggleStatus('${room.name}', '${dish.name}')">
                                ${getStatusText(state.status)}
                            </button>
                        </td>
                        <td class="time-cell" onclick="showTimeModal('${room.name}', '${dish.name}')">
                            ${state.time || '-'}
                        </td>
                        <td class="staff-cell" onclick="showStaffModal('${room.name}', '${dish.name}')">
                            ${state.staff || '-'}
                        </td>
                        <td class="w-count-cell" onclick="showWCountModal('${room.name}', '${dish.name}')">
                            ${state.wCount > 0 ? `W√ó${state.wCount}` : '-'}
                        </td>
                    `;
                    // „ÅîÈ£Ø„ÅÆÂâç„Å´ÊåøÂÖ•
                    const riceIndex = Array.from(tbody.children).findIndex(tr => 
                        tr.querySelector('.course-name').textContent.trim() === '„ÅîÈ£Ø'
                    );
                    if (riceIndex !== -1) {
                        tbody.insertBefore(tr, tbody.children[riceIndex]);
                    }
                });

                // ËøΩÂä†ÊñôÁêÜ(„ÅîÈ£Ø„ÅÆÂæå)
                const afterDishes = settings.additionalDishes.filter(d => 
                    d.position === 'after' && d.rooms.includes(roomIndex)
                );
                
                afterDishes.forEach(dish => {
                    if (!orderState[room.name].courses[dish.name]) {
                        orderState[room.name].courses[dish.name] = {
                            status: 'none',
                            time: null,
                            pressedTime: null,
                            staff: null,
                            wCount: 0
                        };
                    }
                    
                    const state = orderState[room.name].courses[dish.name];
                    const tr = document.createElement('tr');
                    tr.style.background = '#fffbf0';
                    tr.innerHTML = `
                        <td class="course-name">${dish.name}</td>
                        <td>
                            <button class="status-btn ${state.status}" onclick="toggleStatus('${room.name}', '${dish.name}')">
                                ${getStatusText(state.status)}
                            </button>
                        </td>
                        <td class="time-cell" onclick="showTimeModal('${room.name}', '${dish.name}')">
                            ${state.time || '-'}
                        </td>
                        <td class="staff-cell" onclick="showStaffModal('${room.name}', '${dish.name}')">
                            ${state.staff || '-'}
                        </td>
                        <td class="w-count-cell" onclick="showWCountModal('${room.name}', '${dish.name}')">
                            ${state.wCount > 0 ? `W√ó${state.wCount}` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                roomCard.appendChild(table);
                content.appendChild(roomCard);
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó
        function getStatusText(status) {
            const statusMap = {
                'none': 'Êú™',
                'waiting': 'ÂæÖ',
                'ordered': 'Ê≥®',
                'served': 'Êèê'
            };
            return statusMap[status] || 'Êú™';
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÂàá„ÇäÊõø„Åà
        function toggleStatus(roomName, courseName) {
            const state = orderState[roomName].courses[courseName];
            
            // ÂâçÂõû„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
            lastAction = {
                room: roomName,
                course: courseName,
                previousState: { ...state }
            };
            
            const statusCycle = ['none', 'waiting', 'ordered', 'served'];
            const currentIndex = statusCycle.indexOf(state.status);
            const nextIndex = (currentIndex + 1) % statusCycle.length;
            state.status = statusCycle[nextIndex];
            
            // Ê≥®ÊñáÊôÇÂàª„ÇíË®òÈå≤
            if (state.status === 'ordered' && !state.pressedTime) {
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                state.pressedTime = `${h}:${m}`;
            }
            
            saveOrderState();
            renderOrderPage();
        }

        // Êèê‰æõÊôÇÂàªÈÅ∏Êäû„É¢„Éº„ÉÄ„É´
        function showTimeModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Êèê‰æõ‰∫àÂÆöÊôÇÂàª„ÇíÈÅ∏Êäû';
            
            const options = [3, 5, 10, 15, 20, 25];
            body.innerHTML = `
                <div class="modal-buttons">
                    ${options.map(min => `
                        <button class="modal-btn" onclick="setTime('${roomName}', '${courseName}', ${min})">
                            +${min}ÂàÜ
                        </button>
                    `).join('')}
                    <button class="modal-btn" onclick="setTime('${roomName}', '${courseName}', 0)">
                        Â£∞„Åå„Åë
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function setTime(roomName, courseName, minutes) {
            const state = orderState[roomName].courses[courseName];
            
            if (minutes > 0) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + minutes);
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                state.time = `${h}:${m}`;
            } else {
                state.time = 'Â£∞„Åå„Åë';
            }

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // WÊï∞ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´
        function showWCountModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            const room = settings.rooms.find(r => r.name === roomName) || settings.customRooms.find(r => r.name === roomName);
            title.textContent = 'ÁÑº„ÅçÂä†Ê∏õ„ÇíÈÅ∏Êäû';
            
            const options = ['„Å™„Åó', ...Array.from({length: room.people}, (_, i) => i + 1)];
            body.innerHTML = `
                <div class="modal-buttons">
                    ${options.map(opt => `
                        <button class="modal-btn" onclick="setWCount('${roomName}', '${courseName}', '${opt}')">
                            ${opt === '„Å™„Åó' ? '„Å™„Åó' : opt + 'Âêç'}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setWCount(roomName, courseName, count) {
            const state = orderState[roomName].courses[courseName];
            state.wCount = count === '„Å™„Åó' ? 0 : parseInt(count);

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // „Çπ„Çø„ÉÉ„ÉïÈÅ∏Êäû„É¢„Éº„ÉÄ„É´
        function showStaffModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'Êèê‰æõ„Çπ„Çø„ÉÉ„Éï„ÇíÈÅ∏Êäû';
            
            const enabledStaff = [
                ...settings.staff.filter(s => s.enabled),
                ...settings.customStaff.filter(s => s.enabled)
            ];
            
            body.innerHTML = `
                <div class="staff-select-grid">
                    ${enabledStaff.map(staff => `
                        <button class="modal-btn" onclick="setStaff('${roomName}', '${courseName}', '${staff.name}')">
                            ${staff.name}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setStaff(roomName, courseName, staffName) {
            const state = orderState[roomName].courses[courseName];
            state.staff = staffName;

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Undo
        function undoLastAction() {
            if (!lastAction) {
                alert('ÂÖÉ„Å´Êàª„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            orderState[lastAction.room].courses[lastAction.course] = lastAction.previousState;
            lastAction = null;

            saveOrderState();
            renderOrderPage();
        }

        // OrderÂàùÊúüÂåñ
        function resetOrderState() {
            if (!confirm('Order„Éö„Éº„Ç∏„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„Åã?')) return;
            
            initOrderState();
            saveOrderState();
            renderOrderPage();
            alert('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü!');
        }

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            if (tab === 'index') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('index-page').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('order-page').classList.add('active');
                renderOrderPage();
            }
        }

        // Ë®≠ÂÆöÊõ¥Êñ∞Èñ¢Êï∞
        function toggleRoom(index) {
            settings.rooms[index].enabled = !settings.rooms[index].enabled;
            renderIndexPage();
        }

        function updateRoomPeople(index, value) {
            settings.rooms[index].people = parseInt(value);
        }

        function updateRoomTime(index, value) {
            settings.rooms[index].time = value;
        }

        function updateRoomPlan(index, value) {
            settings.rooms[index].plan = value;
            settings.rooms[index].allergies = {};
            renderIndexPage();
        }

        function updateRoomMemo(index, value) {
            settings.rooms[index].memo = value;
        }

        function updateRoomCake(index, checked) {
            settings.rooms[index].hasCake = checked;
        }

        function updateRoomPlate(index, checked) {
            settings.rooms[index].hasPlate = checked;
        }

        function updateAllergy(roomIndex, course, value) {
            settings.rooms[roomIndex].allergies[course] = value;
        }

        function toggleStaff(index) {
            settings.staff[index].enabled = !settings.staff[index].enabled;
        }

        // „Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÈÉ®Â±ãÈñ¢ÈÄ£
        function addCustomRoom() {
            const input = document.getElementById('custom-room-name');
            const name = input.value.trim();
            
            if (!name) {
                alert('ÈÉ®Â±ãÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            settings.customRooms.push({
                name: name,
                enabled: true,
                people: 2,
                time: '18:00',
                plan: '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ',
                memo: '',
                allergies: {},
                hasCake: false,
                hasPlate: false,
                isCustom: true
            });
            
            input.value = '';
            renderIndexPage();
        }

        function deleteCustomRoom(index) {
            if (confirm('„Åì„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÈÉ®Â±ã„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
                settings.customRooms.splice(index, 1);
                renderIndexPage();
            }
        }

        function toggleCustomRoom(index) {
            settings.customRooms[index].enabled = !settings.customRooms[index].enabled;
            renderIndexPage();
        }

        function updateCustomRoomName(index, value) {
            settings.customRooms[index].name = value;
        }

        function updateCustomRoomPeople(index, value) {
            settings.customRooms[index].people = parseInt(value);
        }

        function updateCustomRoomTime(index, value) {
            settings.customRooms[index].time = value;
        }

        function updateCustomRoomPlan(index, value) {
            settings.customRooms[index].plan = value;
            settings.customRooms[index].allergies = {};
            renderIndexPage();
        }

        function updateCustomRoomMemo(index, value) {
            settings.customRooms[index].memo = value;
        }

        function updateCustomRoomCake(index, checked) {
            settings.customRooms[index].hasCake = checked;
        }

        function updateCustomRoomPlate(index, checked) {
            settings.customRooms[index].hasPlate = checked;
        }

        // „Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çπ„Çø„ÉÉ„ÉïÈñ¢ÈÄ£
        function addCustomStaff() {
            const input = document.getElementById('custom-staff-input');
            const name = input.value.trim();
            
            if (!name) {
                alert('„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            settings.customStaff.push({
                name: name,
                enabled: true,
                isCustom: true
            });
            
            input.value = '';
            renderIndexPage();
        }

        function deleteCustomStaff(index) {
            if (confirm('„Åì„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çπ„Çø„ÉÉ„Éï„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
                settings.customStaff.splice(index, 1);
                renderIndexPage();
            }
        }

        function toggleCustomStaff(index) {
            settings.customStaff[index].enabled = !settings.customStaff[index].enabled;
        }

        // „Ç¢„É¨„É´„ÇÆ„ÉºË®≠ÂÆö„É¢„Éº„ÉÄ„É´
        function showAllergyModal(roomIndex, isCustom) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            const room = isCustom ? settings.customRooms[roomIndex] : settings.rooms[roomIndex];
            const courses = PLANS[room.plan];
            
            title.textContent = `${room.name} - „Ç¢„É¨„É´„ÇÆ„ÉºË®≠ÂÆö`;
            
            body.innerHTML = `
                <div class="allergy-modal-content">
                    ${courses.map(course => `
                        <div class="allergy-input-group">
                            <label>${course}</label>
                            <input type="text" 
                                   id="allergy-${course}" 
                                   value="${room.allergies[course] || ''}" 
                                   placeholder="‰æã: „Åà„Å≥„Éª„Åã„Å´">
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-primary" onclick="saveAllergies(${roomIndex}, ${isCustom})">
                    ‰øùÂ≠ò
                </button>
            `;
            
            modal.classList.add('active');
        }

        function saveAllergies(roomIndex, isCustom) {
            const room = isCustom ? settings.customRooms[roomIndex] : settings.rooms[roomIndex];
            const courses = PLANS[room.plan];
            
            courses.forEach(course => {
                const input = document.getElementById(`allergy-${course}`);
                if (input) {
                    room.allergies[course] = input.value.trim();
                }
            });
            
            closeModal();
            alert('„Ç¢„É¨„É´„ÇÆ„ÉºË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }

        // È£ü„Åπ„Çã„Çπ„Éî„Éº„ÉâÈÅ∏Êäû„É¢„Éº„ÉÄ„É´
        function showEatingSpeedModal(roomName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'È£ü„Åπ„Çã„Çπ„Éî„Éº„Éâ„ÇíÈÅ∏Êäû';
            
            body.innerHTML = `
                <div class="modal-buttons">
                    ${EATING_SPEEDS.map(speed => `
                        <button class="modal-btn" onclick="setEatingSpeed('${roomName}', '${speed}')">
                            ${speed}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setEatingSpeed(roomName, speed) {
            if (!orderState[roomName]) {
                orderState[roomName] = { eatingSpeed: 'N', courses: {} };
            }
            orderState[roomName].eatingSpeed = speed;

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // ËøΩÂä†ÊñôÁêÜÈñ¢ÈÄ£
        function addDish() {
            settings.additionalDishes.push({
                name: '',
                position: 'before',
                rooms: []
            });
            renderIndexPage();
        }

        function deleteDish(index) {
            if (confirm('„Åì„ÅÆËøΩÂä†ÊñôÁêÜ„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
                settings.additionalDishes.splice(index, 1);
                renderIndexPage();
            }
        }

        function updateDishName(index, value) {
            settings.additionalDishes[index].name = value;
        }

        function updateDishPosition(index, value) {
            settings.additionalDishes[index].position = value;
        }

        function updateDishRooms(index, value) {
            settings.additionalDishes[index].rooms = value.split(',').map(s => s.trim()).filter(s => s);
        }

        // ÂàùÊúüÂåñÂÆüË°å
        init();
    </script>
</body>
</html>
