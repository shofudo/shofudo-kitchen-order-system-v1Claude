<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚­ãƒƒãƒãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="./manifest-kitchen.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ã‚­ãƒƒãƒãƒ³">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 5px;
            overflow-x: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¨ªä¸¦ã³ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            color: #2c3e50;
            white-space: nowrap;
        }

        .last-update {
            font-size: 13px;
            color: #7f8c8d;
            white-space: nowrap;
        }

        /* é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        .sound-test-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .sound-test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.5);
        }

        .sound-test-btn:active {
            transform: translateY(0);
        }

        /* ãƒ†ã‚¹ãƒˆä¸­ã®çŠ¶æ…‹ */
        .sound-test-btn.testing {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            box-shadow: 0 2px 8px rgba(255, 167, 38, 0.4);
            animation: pulse 1s ease-in-out;
        }

        /* æˆåŠŸçŠ¶æ…‹ */
        .sound-test-btn.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            box-shadow: 0 2px 8px rgba(81, 207, 102, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .sound-test-btn.hidden {
            display: none;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .last-update {
                font-size: 12px;
            }
            
            .sound-test-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - ã‚ˆã‚Šå¤šãã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º */
        .dish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 12px;
            margin-bottom: 10px;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
        .dish-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
            border: 2px solid #3498db;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
        .dish-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 3px solid #3498db;
        }

        .dish-name-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .dish-name {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.2;
        }

        .dish-furigana {
            font-size: 24px;
            font-weight: bold;
            color: #7f8c8d;
            line-height: 1.2;
        }

        .dish-total {
            font-size: 40px;
            font-weight: bold;
            color: #e74c3c;
            background: #ffe6e6;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
            min-width: 100px;
            text-align: center;
        }

        /* æ³¨æ–‡ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
        .order-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* å„æ³¨æ–‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
        .order-item {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        /* éƒ¨å±‹åã¨ã‚¿ã‚°ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹è¡Œ */
        .room-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        /* å·¦å´ã®éƒ¨å±‹å */
        .room-name-left {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .room-icon {
            font-size: 16px;
        }

        /* å³å´ã®ã‚¿ã‚°ç¾¤ */
        .tags-right {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
        }

        /* å„ã‚¿ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        .detail-tag {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
        }

        /* ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚¿ã‚° - èµ¤è‰²ã§ç›®ç«‹ã¤ã‚ˆã†ã« */
        .allergy-tag {
            background: #ff6b6b;
            color: white;
            border: 3px solid #c92a2a;
            font-size: 16px;
        }

        /* ç«å…¥ã‚Œã‚¿ã‚°(WÃ—2ãªã©) - ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§ç›®ç«‹ã¤ã‚ˆã†ã« */
        .w-tag {
            background: #ffa94d;
            color: #fff;
            border: 3px solid #ff8c00;
            font-size: 16px;
        }

        /* æ‹…å½“è€…ã‚¿ã‚° */
        .staff-tag {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        /* ç©ºã®çŠ¶æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .empty-state h2 {
            font-size: 32px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .empty-state p {
            font-size: 20px;
            color: #7f8c8d;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 768px) {
            .dish-grid {
                grid-template-columns: 1fr;
            }
            
            .dish-name {
                font-size: 24px;
            }
            
            .dish-furigana {
                font-size: 20px;
            }
            
            .dish-total {
                font-size: 32px;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }

        .loading-spinner {
            border: 6px solid #e0e0e0;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ³ ã‚­ãƒƒãƒãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</h1>
        <div class="last-update" id="last-update">æ¥ç¶šä¸­...</div>
        <button class="sound-test-btn" id="sound-test-btn" onclick="testNotificationSound()">
            ğŸ”” é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆ
        </button>
    </div>

    <div id="content">
        <div class="loading">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // æ–™ç†åã®ãµã‚ŠãŒãªå¯¾å¿œè¡¨
        const COURSE_FURIGANA = {
            "å¸ç‰©": "ã™ã„ã‚‚ã®",
            "æœèœç››ã‚Š": "ã‹ã•ã„ã‚‚ã‚Š",
            "è’¸ç‰©": "ã‚€ã—ã‚‚ã®",
            "æšç‰©": "ã‚ã’ã‚‚ã®",
            "ç…®ç‰©": "ã«ã‚‚ã®",
            "ã”é£¯": "ã”ã¯ã‚“",
            "ç”˜å‘³": "ã‹ã‚“ã¿",
            "ã™ãç„¼ã": "ã™ãã‚„ã",
            "ãƒ•ãƒ©ã‚¤": "ãµã‚‰ã„",
            "ã‚¹ãƒ†ãƒ¼ã‚­": "ã™ã¦ãƒ¼ã",
            "é‹": "ãªã¹",
            "é®‘": "ã‚ã‚ã³"
        };

        // éƒ¨å±‹ã®è¡¨ç¤ºé †åº
        const ROOM_ORDER = ["ã‚„ã¾ã¶ã", "ã‚ã™ã‚Œãªè‰", "ã—ã‚ƒããªã’", "ã‚ã‚“ãš", "ãªã¤ã‚"];

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAoyApbQzAlSYsM1MBDPZ68I5EaJ3M_yE8",
            authDomain: "restaurant-order-system-8855a.firebaseapp.com",
            databaseURL: "https://restaurant-order-system-8855a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "restaurant-order-system-8855a",
            storageBucket: "restaurant-order-system-8855a.firebasestorage.app",
            messagingSenderId: "695114713080",
            appId: "1:695114713080:web:de13ca2e7e448e92fb380d"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const ordersRef = ref(database, 'orders');

        // å‰å›ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒ(é€šçŸ¥éŸ³ç”¨)
        let previousOrderStatuses = {};

        // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ©ã‚°
        let initialDataLoaded = false;

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š(10ç§’ä»¥å†…ã«ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤º)
        const loadingTimeout = setTimeout(() => {
            if (!initialDataLoaded) {
                showError('æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ', 'Firebaseã¸ã®æ¥ç¶šã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }, 10000);

        // AudioContextã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§1ã¤ã ã‘ä¿æŒ(iOS Safariå¯¾ç­–)
        let audioContext = null;
        let audioInitialized = false;

        // AudioContextã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        function initAudioContext() {
            if (audioInitialized) return;
            
            try {
                // AudioContextã‚’1å›ã ã‘ä½œæˆã—ã¦ä¿æŒ
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.resume().then(() => {
                    audioInitialized = true;
                    console.log('éŸ³å£°ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ - AudioContext ready');
                });
            } catch (error) {
                console.error('éŸ³å£°ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•çš„ã«éŸ³å£°ã‚’åˆæœŸåŒ–(ä¸€éƒ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§æœ‰åŠ¹)
        window.addEventListener('load', initAudioContext);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã§éŸ³å£°ã‚’æœ‰åŠ¹åŒ–
        document.addEventListener('click', initAudioContext, { once: true });
        document.addEventListener('touchstart', initAudioContext, { once: true });

        // é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
        function testNotificationSound() {
            const btn = document.getElementById('sound-test-btn');
            
            // ãƒœã‚¿ãƒ³ã‚’ã€Œãƒ†ã‚¹ãƒˆä¸­ã€çŠ¶æ…‹ã«
            btn.innerHTML = 'ğŸ”Š ãƒ†ã‚¹ãƒˆä¸­...';
            btn.classList.add('testing');
            btn.disabled = true;
            
            // AudioContextã‚’åˆæœŸåŒ–
            initAudioContext();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰éŸ³ã‚’å†ç”Ÿ
            setTimeout(() => {
                if (audioInitialized) {
                    // ãƒ†ã‚¹ãƒˆéŸ³ã‚’å†ç”Ÿ
                    playNotificationSound();
                    
                    // ãƒœã‚¿ãƒ³ã‚’ã€ŒæˆåŠŸã€çŠ¶æ…‹ã«
                    btn.classList.remove('testing');
                    btn.classList.add('success');
                    btn.innerHTML = 'âœ… é€šçŸ¥éŸ³ãŒæœ‰åŠ¹ã§ã™';
                    btn.disabled = false;
                    
                    // 5ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    setTimeout(() => {
                        btn.classList.add('hidden');
                    }, 5000);
                } else {
                    // åˆæœŸåŒ–å¤±æ•— - ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    btn.classList.remove('testing');
                    btn.innerHTML = 'ğŸ”” é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆ';
                    btn.disabled = false;
                    alert('é€šçŸ¥éŸ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }, 300);
        }

        // é€šçŸ¥éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°(ã‚ˆã‚Šç›®ç«‹ã¤éŸ³ã«æ”¹å–„)
        function playNotificationSound() {
            console.log('é€šçŸ¥éŸ³ã‚’å†ç”Ÿã—ã¾ã™');

            // AudioContextãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
            if (!audioContext || !audioInitialized) {
                console.warn('AudioContextã‚’åˆæœŸåŒ–ä¸­...');
                initAudioContext();
                // åˆæœŸåŒ–å¾Œã«å†åº¦å†ç”Ÿã‚’è©¦ã¿ã‚‹
                setTimeout(() => {
                    if (audioInitialized) {
                        playNotificationSound();
                    } else {
                        console.warn('AudioContextãŒåˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
                    }
                }, 100);
                return;
            }

            try {
                // 2æ®µéšã®éŸ³ã‚’é³´ã‚‰ã™(ãƒ”ãƒ­ãƒ³â™ªã¨ã„ã†æ„Ÿã˜)
                const now = audioContext.currentTime;
                
                // 1éŸ³ç›® (é«˜ã„éŸ³)
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.frequency.value = 1000; // 1000Hz
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.4, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                // 2éŸ³ç›® (å°‘ã—ä½ã„éŸ³)
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 800; // 800Hz
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.4, now + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.3);
                
                console.log('é€šçŸ¥éŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('é€šçŸ¥éŸ³ã®å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
        onValue(ordersRef, (snapshot) => {
            // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ
            if (!initialDataLoaded) {
                initialDataLoaded = true;
                clearTimeout(loadingTimeout);
                console.log('Firebaseæ¥ç¶šæˆåŠŸ');
            }
            
            const orderData = snapshot.val();
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚’æ¤œå‡ºã—ã¦é€šçŸ¥éŸ³ã‚’é³´ã‚‰ã™
            checkForNewOrders(orderData);
            
            updateDisplay(orderData);
            updateLastUpdate();
        }, (error) => {
            console.error('Firebaseã‚¨ãƒ©ãƒ¼:', error);
            clearTimeout(loadingTimeout);
            
            // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (error.code === 'PERMISSION_DENIED') {
                showError('æ¨©é™ã‚¨ãƒ©ãƒ¼', 'Firebaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Database Rulesã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else if (error.code === 'NETWORK_ERROR') {
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼', `Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code || 'ä¸æ˜'}`);
            }
        });

        // æ–°ã—ã„ã€Œæ³¨ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¤œå‡º
        function checkForNewOrders(orderData) {
            if (!orderData) return;

            let hasNewOrder = false;

            Object.entries(orderData).forEach(([roomName, roomData]) => {
                if (!roomData.courses) return;

                Object.entries(roomData.courses).forEach(([courseName, courseData]) => {
                    const key = `${roomName}_${courseName}`;
                    const currentStatus = courseData.status;
                    const previousStatus = previousOrderStatuses[key];

                    // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã€ã€Œorderã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰åŒ–ã‚’æ¤œå‡º
                    if (initialDataLoaded) {
                        // ä»¥å‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå­˜åœ¨ã—ã€ã‹ã¤ã€Œorderã€ä»¥å¤–ã‹ã‚‰ã€Œorderã€ã«å¤‰ã‚ã£ãŸå ´åˆ
                        if (previousStatus && previousStatus !== 'order' && currentStatus === 'order') {
                            hasNewOrder = true;
                            console.log(`æ–°ã—ã„æ³¨æ–‡ã‚’æ¤œå‡º: ${roomName} - ${courseName}`);
                        }
                    }

                    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜
                    previousOrderStatuses[key] = currentStatus;
                });
            });

            if (hasNewOrder) {
                playNotificationSound();
            }
        }

        // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('last-update').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;
        }

        // éƒ¨å±‹åã‚’ä¸¦ã³æ›¿ãˆã‚‹é–¢æ•°
        function sortRoomsByOrder(rooms) {
            return rooms.sort((a, b) => {
                const indexA = ROOM_ORDER.indexOf(a.roomName);
                const indexB = ROOM_ORDER.indexOf(b.roomName);
                
                // ä¸¡æ–¹ã¨ã‚‚å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é †åºã§æ¯”è¼ƒ
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                // ç‰‡æ–¹ã ã‘å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€å®šç¾©ã•ã‚Œã¦ã„ã‚‹æ–¹ã‚’å‰ã«
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                // ã©ã¡ã‚‰ã‚‚å®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åå‰ã§æ¯”è¼ƒ
                return a.roomName.localeCompare(b.roomName, 'ja');
            });
        }

        // ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’æ›´æ–°
        function updateDisplay(orderData) {
            const content = document.getElementById('content');
            
            // --- è¨­å®š: ã¾ã¨ã‚ã‚‹æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ ---
            const BATCH_WINDOW_MS = 5 * 1000; // 5ç§’
            
            if (!orderData) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸ“‹ æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                        <p>iPadã§æ³¨æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            // 1. ã¾ãšå…¨ã¦ã®æœ‰åŠ¹ãªæ³¨æ–‡ã‚’ãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã«æŠ½å‡º
            let allOrders = [];
            
            Object.entries(orderData).forEach(([roomName, roomData]) => {
                if (!roomData.courses) return;
                
                Object.entries(roomData.courses).forEach(([courseName, courseData]) => {
                    // ã€Œæ³¨ã€(order)ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ–™ç†ã®ã¿å¯¾è±¡
                    if (courseData.status !== 'order') return;
                    
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒãªã„å ´åˆï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ãªã©ï¼‰ã¯ç¾åœ¨æ™‚åˆ»æ‰±ã„ã«ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚
                    // 0 ã¾ãŸã¯ éå¸¸ã«å¤ã„æ™‚åˆ»ã¨ã—ã¦æ‰±ã†
                    const timestamp = courseData.orderTimestamp || 0;

                    allOrders.push({
                        dishName: courseName,
                        roomName: roomName,
                        people: roomData.people || 2,
                        allergy: courseData.allergy || '',
                        wCount: courseData.wCount || 0,
                        staff: courseData.staff,
                        pressedTime: courseData.pressedTime,
                        timestamp: timestamp
                    });
                });
            });

            if (allOrders.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>âœ… å…¨ã¦ã®æ³¨æ–‡ãŒå‡¦ç†æ¸ˆã¿ã§ã™</h2>
                        <p>æ–°ã—ã„æ³¨æ–‡ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™</p>
                    </div>
                `;
                return;
            }

            // 2. æ–™ç†åã”ã¨ã«ä¸€æ™‚çš„ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
            const tempByDish = {};
            allOrders.forEach(order => {
                if (!tempByDish[order.dishName]) {
                    tempByDish[order.dishName] = [];
                }
                tempByDish[order.dishName].push(order);
            });

            // 3. å„æ–™ç†ã®ä¸­ã§ã€æ™‚é–“ã«åŸºã¥ã„ã¦ã€Œãƒãƒƒãƒï¼ˆã‹ãŸã¾ã‚Šï¼‰ã€ã«åˆ†å‰²ã™ã‚‹
            let displayBatches = [];

            Object.keys(tempByDish).forEach(dishName => {
                const orders = tempByDish[dishName];
                
                // æ™‚é–“é †ï¼ˆå¤ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
                orders.sort((a, b) => a.timestamp - b.timestamp);

                let currentBatch = [];
                let batchStartTime = null;

                orders.forEach(order => {
                    if (currentBatch.length === 0) {
                        // æ–°ã—ã„ãƒãƒƒãƒã®é–‹å§‹
                        currentBatch.push(order);
                        batchStartTime = order.timestamp;
                    } else {
                        // åŸºæº–æ™‚é–“ï¼ˆãƒãƒƒãƒã®æœ€åˆã®æ³¨æ–‡ï¼‰ã‹ã‚‰20ç§’ä»¥å†…ã‹ãƒã‚§ãƒƒã‚¯
                        // â€» timestampãŒ0(å¤ã„ãƒ‡ãƒ¼ã‚¿)åŒå£«ã®å ´åˆã¯å¸¸ã«ä¸€ç·’ã«ã™ã‚‹
                        if (batchStartTime === 0 || (order.timestamp - batchStartTime <= BATCH_WINDOW_MS)) {
                            currentBatch.push(order);
                        } else {
                            // 20ç§’ã‚’è¶…ãˆãŸã®ã§ã€ä»Šã®ãƒãƒƒãƒã‚’ç¢ºå®šã•ã›ã¦æ–°ã—ã„ãƒãƒƒãƒã‚’ä½œã‚‹
                            displayBatches.push({
                                dishName: dishName,
                                orders: currentBatch,
                                startTime: batchStartTime
                            });
                            currentBatch = [order];
                            batchStartTime = order.timestamp;
                        }
                    }
                });

                // æ®‹ã£ã¦ã„ã‚‹ãƒãƒƒãƒã‚’è¿½åŠ 
                if (currentBatch.length > 0) {
                    displayBatches.push({
                        dishName: dishName,
                        orders: currentBatch,
                        startTime: batchStartTime
                    });
                }
            });

            // 4. è¡¨ç¤ºé †ã®æ±ºå®šï¼ˆå¤ã„ãƒãƒƒãƒé †ã€ã‚ã‚‹ã„ã¯æ–™ç†é †ãªã©ï¼‰
            // ã“ã“ã§ã¯ã€Œãƒãƒƒãƒã®é–‹å§‹æ™‚é–“ãŒå¤ã„é †ã€ã«ä¸¦ã¹ã¦è¡¨ç¤ºã—ã¾ã™
            displayBatches.sort((a, b) => a.startTime - b.startTime);


            // 5. HTMLç”Ÿæˆ
            // 5. HTMLç”Ÿæˆ
            let html = '<div class="dish-grid">';
            
            displayBatches.forEach(batch => {
                const dishName = batch.dishName;
                const orders = batch.orders;
                
                // éƒ¨å±‹ã®é †åºã§ã‚½ãƒ¼ãƒˆ
                const sortedOrders = sortRoomsByOrder(orders);
                const totalPeople = sortedOrders.reduce((sum, order) => sum + order.people, 0);
                
                // ãµã‚ŠãŒãª
                const furigana = COURSE_FURIGANA[dishName] || '';
                
                // â˜…è¿½åŠ : ç™ºæ³¨æ™‚é–“ã‚’æ•´å½¢ï¼ˆä¾‹: "18:05"ï¼‰
                let timeString = '';
                if (batch.startTime && batch.startTime > 0) {
                    const date = new Date(batch.startTime);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    // ç§’ã¾ã§å‡ºã—ãŸã„å ´åˆã¯ã“ã“ã‚’èª¿æ•´
                    timeString = `${hours}:${minutes}`; 
                }
                
                // å¤ã„æ³¨æ–‡ã®è­¦å‘Šåˆ¤å®š
                const isOldOrder = (Date.now() - batch.startTime > 300000) && batch.startTime !== 0;

                html += `
                    <div class="dish-card" style="${isOldOrder ? 'border-color: #e74c3c;' : ''}">
                        <div class="dish-header">
                            <div class="dish-name-container">
                                <div class="dish-name">${dishName}</div>
                                ${furigana ? `<div class="dish-furigana">${furigana}</div>` : ''}
                            </div>
                            
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                                <div class="dish-total">${totalPeople}å</div>
                                ${timeString ? `<div style="font-size: 16px; font-weight: bold; color: #555;">ğŸ•’ ${timeString}</div>` : ''}
                            </div>
                        </div>
                        <div class="order-list">
                `;
                
                // (ä»¥ä¸‹ã€ä»¥å‰ã¨åŒã˜æ³¨æ–‡ãƒªã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒ—å‡¦ç†)
                sortedOrders.forEach(order => {
                    html += `<div class="order-item">`;
                    html += `<div class="room-row">`;
                    html += `
                        <div class="room-name-left">
                            <span class="room-icon">ğŸ </span>
                            ${order.roomName}
                        </div>
                    `;
                    html += `<div class="tags-right">`;
                    if (order.wCount > 0) {
                        html += `<span class="detail-tag w-tag">ğŸ”¥ WÃ—${order.wCount}</span>`;
                    }
                    if (order.allergy) {
                        html += `<span class="detail-tag allergy-tag">${order.allergy}NG</span>`;
                    }
                    if (order.staff) {
                        html += `<span class="detail-tag staff-tag">ğŸ‘¤ ${order.staff}</span>`;
                    }
                    html += `</div>`; 
                    html += `</div>`; 
                    html += '</div>'; 
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(title = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼', message = 'Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ') {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="empty-state">
                    <h2>âŒ ${title}</h2>
                    <p>${message}</p>
                    <p style="margin-top: 15px; font-size: 18px;">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>
                    <button onclick="location.reload()" style="
                        margin-top: 20px;
                        padding: 15px 30px;
                        font-size: 18px;
                        font-weight: bold;
                        background: #3498db;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
                    ">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
        }
    </script>
    
    <!-- Service Workerç™»éŒ² -->
    <script>
        if ('serviceWorker' in navigator) {
            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Service Workerã‚’ç™»éŒ²
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration.scope);
                    
                    // æ–°ã—ã„Service Workerã®æ›´æ–°ã‚’æ¤œå‡º
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('æ–°ã—ã„Service WorkerãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // æ–°ã—ã„Service WorkerãŒåˆ©ç”¨å¯èƒ½
                                console.log('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚æ›´æ–°ã‚’é©ç”¨ã—ã¾ã™...');
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                    
                    // å®šæœŸçš„ã«æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯(1æ™‚é–“ã”ã¨)
                    setInterval(() => {
                        registration.update();
                    }, 60 * 60 * 1000);
                })
                .catch((error) => {
                    console.log('Service Workerç™»éŒ²å¤±æ•—:', error);
                });
            
            // Service WorkerãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    console.log('Service WorkerãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...');
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>
