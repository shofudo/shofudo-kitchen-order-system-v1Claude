<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚­ãƒƒãƒãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</title>
    
    <link rel="manifest" href="./manifest-kitchen.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ã‚­ãƒƒãƒãƒ³">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã«æ–‡å­—ãŒé¸æŠã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 5px;
            overflow-x: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            color: #2c3e50;
            white-space: nowrap;
        }

        .last-update {
            font-size: 13px;
            color: #7f8c8d;
            white-space: nowrap;
        }

        /* é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ */
        .sound-test-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .sound-test-btn:active { transform: translateY(0); }
        .sound-test-btn.testing {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            animation: pulse 1s ease-in-out;
        }
        .sound-test-btn.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }
        .sound-test-btn.hidden { display: none; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            .header { flex-wrap: wrap; gap: 10px; }
            .header h1 { font-size: 18px; }
            .last-update { font-size: 12px; }
            .sound-test-btn { padding: 6px 12px; font-size: 13px; }
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .dish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 12px;
            margin-bottom: 10px;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .dish-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
            border: 2px solid #3498db;
        }

        .dish-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 3px solid #3498db;
        }

        .dish-name-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .dish-name {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.2;
        }

        .dish-furigana {
            font-size: 24px;
            font-weight: bold;
            color: #7f8c8d;
            line-height: 1.2;
        }

        .dish-total {
            font-size: 40px;
            font-weight: bold;
            color: #e74c3c;
            background: #ffe6e6;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
            min-width: 100px;
            text-align: center;
        }

        /* æ³¨æ–‡ãƒªã‚¹ãƒˆ */
        .order-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* â˜…ã“ã“ãŒé‡è¦ï¼šã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹è¡Œã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .order-item {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 10px;
            border-left: 6px solid #3498db;
            cursor: pointer; /* æŒ‡ãƒãƒ¼ã‚¯ã«ã™ã‚‹ */
            transition: all 0.2s;
            position: relative;
        }

        /* ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã®å‹•ã */
        .order-item:active {
            transform: scale(0.98);
        }

        /* â˜…ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼ˆå®Œäº†ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .order-item.checked {
            background: #e0e0e0;     /* èƒŒæ™¯ã‚’ã‚°ãƒ¬ãƒ¼ã« */
            border-left-color: #95a5a6; /* å·¦ã®ç·šã‚’ã‚°ãƒ¬ãƒ¼ã« */
            opacity: 0.7;             /* å…¨ä½“ã‚’å°‘ã—è–„ã */
        }
        
        .order-item.checked .room-name-left {
            text-decoration: line-through; /* æ–‡å­—ã«å–ã‚Šæ¶ˆã—ç·š */
            color: #7f8c8d;
        }

        /* ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ï¼ˆæ™®æ®µã¯éš ã‚Œã¦ã„ã‚‹ï¼‰ */
        .check-mark {
            display: none;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #27ae60;
            font-weight: bold;
            z-index: 10;
        }

        /* ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‰è¡¨ç¤ºã™ã‚‹ */
        .order-item.checked .check-mark {
            display: block;
        }

        .room-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .room-name-left {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* â˜…äººæ•°ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .people-count {
            background: #34495e;
            color: white;
            font-size: 14px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        /* ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‰äººæ•°ã‚‚ã‚°ãƒ¬ãƒ¼ã« */
        .order-item.checked .people-count {
            background: #95a5a6;
        }

        .tags-right {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
            padding-right: 30px; /* ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã¨ã‹ã¶ã‚‰ãªã„ã‚ˆã†ã«éš™é–“ã‚’ã‚ã‘ã‚‹ */
        }

        .detail-tag {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
        }

        .allergy-tag {
            background: #ff6b6b;
            color: white;
            border: 3px solid #c92a2a;
            font-size: 16px;
        }

        .w-tag {
            background: #ffa94d;
            color: #fff;
            border: 3px solid #ff8c00;
            font-size: 16px;
        }

        .staff-tag {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .empty-state h2 {
            font-size: 32px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .empty-state p {
            font-size: 20px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .dish-grid { grid-template-columns: 1fr; }
            .dish-name { font-size: 24px; }
            .dish-furigana { font-size: 20px; }
            .dish-total { font-size: 32px; }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }

        .loading-spinner {
            border: 6px solid #e0e0e0;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ³ ã‚­ãƒƒãƒãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</h1>
        <div class="last-update" id="last-update">æ¥ç¶šä¸­...</div>
        <button class="sound-test-btn" id="sound-test-btn" onclick="testNotificationSound()">
            ğŸ”” é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆ
        </button>
    </div>

    <div id="content">
        <div class="loading">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const COURSE_FURIGANA = {
            "å¸ç‰©": "ã™ã„ã‚‚ã®",
            "æœèœç››ã‚Š": "ã‹ã•ã„ã‚‚ã‚Š",
            "è’¸ç‰©": "ã‚€ã—ã‚‚ã®",
            "æšç‰©": "ã‚ã’ã‚‚ã®",
            "ç…®ç‰©": "ã«ã‚‚ã®",
            "ã”é£¯": "ã”ã¯ã‚“",
            "ç”˜å‘³": "ã‹ã‚“ã¿",
            "ã™ãç„¼ã": "ã™ãã‚„ã",
            "ãƒ•ãƒ©ã‚¤": "ãµã‚‰ã„",
            "ã‚¹ãƒ†ãƒ¼ã‚­": "ã™ã¦ãƒ¼ã",
            "é‹": "ãªã¹",
            "é®‘": "ã‚ã‚ã³"
        };

        const ROOM_ORDER = ["ã‚„ã¾ã¶ã", "ã‚ã™ã‚Œãªè‰", "ã—ã‚ƒããªã’", "ã‚ã‚“ãš", "ãªã¤ã‚"];

        const firebaseConfig = {
            apiKey: "AIzaSyAoyApbQzAlSYsM1MBDPZ68I5EaJ3M_yE8",
            authDomain: "restaurant-order-system-8855a.firebaseapp.com",
            databaseURL: "https://restaurant-order-system-8855a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "restaurant-order-system-8855a",
            storageBucket: "restaurant-order-system-8855a.firebasestorage.app",
            messagingSenderId: "695114713080",
            appId: "1:695114713080:web:de13ca2e7e448e92fb380d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const ordersRef = ref(database, 'orders');

        let previousOrderStatuses = {};
        let initialDataLoaded = false;
        
        // â˜…ã€ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã€‘ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’è¨˜æ†¶ã—ã¦ãŠãç®±
        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚è¦šãˆã¦ã„ã‚‹ã‚ˆã†ã« localStorage ã‚’ä½¿ã„ã¾ã™
        let checkedItems = JSON.parse(localStorage.getItem('kitchenCheckedItems')) || {};

        const loadingTimeout = setTimeout(() => {
            if (!initialDataLoaded) {
                showError('æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ', 'Firebaseã¸ã®æ¥ç¶šã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }, 10000);

        let audioContext = null;
        let audioInitialized = false;

        function initAudioContext() {
            if (audioInitialized) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.resume().then(() => {
                    audioInitialized = true;
                    console.log('éŸ³å£°ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ - AudioContext ready');
                });
            } catch (error) {
                console.error('éŸ³å£°ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        window.addEventListener('load', initAudioContext);
        document.addEventListener('click', initAudioContext, { once: true });
        document.addEventListener('touchstart', initAudioContext, { once: true });

        function testNotificationSound() {
            const btn = document.getElementById('sound-test-btn');
            btn.innerHTML = 'ğŸ”Š ãƒ†ã‚¹ãƒˆä¸­...';
            btn.classList.add('testing');
            btn.disabled = true;
            initAudioContext();
            setTimeout(() => {
                if (audioInitialized) {
                    playNotificationSound();
                    btn.classList.remove('testing');
                    btn.classList.add('success');
                    btn.innerHTML = 'âœ… é€šçŸ¥éŸ³ãŒæœ‰åŠ¹ã§ã™';
                    btn.disabled = false;
                    setTimeout(() => {
                        btn.classList.add('hidden');
                    }, 5000);
                } else {
                    btn.classList.remove('testing');
                    btn.innerHTML = 'ğŸ”” é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆ';
                    btn.disabled = false;
                    alert('é€šçŸ¥éŸ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }, 300);
        }

        function playNotificationSound() {
            if (!audioContext || !audioInitialized) {
                initAudioContext();
                setTimeout(() => {
                    if (audioInitialized) playNotificationSound();
                }, 100);
                return;
            }
            try {
                const now = audioContext.currentTime;
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                osc1.frequency.value = 1000;
                osc1.type = 'sine';
                gain1.gain.setValueAtTime(0.4, now);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 800;
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.4, now + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.3);
            } catch (error) {
                console.error('é€šçŸ¥éŸ³ã®å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        onValue(ordersRef, (snapshot) => {
            if (!initialDataLoaded) {
                initialDataLoaded = true;
                clearTimeout(loadingTimeout);
                console.log('Firebaseæ¥ç¶šæˆåŠŸ');
            }
            const orderData = snapshot.val();
            checkForNewOrders(orderData);
            updateDisplay(orderData);
            updateLastUpdate();
        }, (error) => {
            if (error.code === 'PERMISSION_DENIED') {
                showError('æ¨©é™ã‚¨ãƒ©ãƒ¼', 'Firebaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            } else if (error.code === 'NETWORK_ERROR') {
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼', `Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code || 'ä¸æ˜'}`);
            }
        });

        function checkForNewOrders(orderData) {
            if (!orderData) return;
            let hasNewOrder = false;
            Object.entries(orderData).forEach(([roomName, roomData]) => {
                if (!roomData.courses) return;
                Object.entries(roomData.courses).forEach(([courseName, courseData]) => {
                    const key = `${roomName}_${courseName}`;
                    const currentStatus = courseData.status;
                    const previousStatus = previousOrderStatuses[key];
                    if (initialDataLoaded) {
                        if (previousStatus && previousStatus !== 'order' && currentStatus === 'order') {
                            hasNewOrder = true;
                            // æ–°ã—ã„æ³¨æ–‡ãŒæ¥ãŸã‚‰ã€ãã®æ–™ç†ã®ãƒã‚§ãƒƒã‚¯è¨˜éŒ²ã‚’æ¶ˆã™ï¼ˆå¾©æ´»ã•ã›ã‚‹ï¼‰
                            // â€»åŒã˜éƒ¨å±‹ã§åŒã˜æ–™ç†ãŒå†åº¦æ³¨æ–‡ã•ã‚ŒãŸå ´åˆã®è€ƒæ…®
                            const checkKey = `${courseName}_${roomName}`;
                            if (checkedItems[checkKey]) {
                                delete checkedItems[checkKey];
                                localStorage.setItem('kitchenCheckedItems', JSON.stringify(checkedItems));
                            }
                        }
                    }
                    previousOrderStatuses[key] = currentStatus;
                });
            });
            if (hasNewOrder) {
                playNotificationSound();
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('last-update').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;
        }

        function sortRoomsByOrder(rooms) {
            return rooms.sort((a, b) => {
                const indexA = ROOM_ORDER.indexOf(a.roomName);
                const indexB = ROOM_ORDER.indexOf(b.roomName);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.roomName.localeCompare(b.roomName, 'ja');
            });
        }

        // â˜…ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹æ©Ÿèƒ½
        window.toggleCheck = function(dishName, roomName) {
            const key = `${dishName}_${roomName}`;
            
            // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åè»¢ã•ã›ã‚‹ï¼ˆã‚ªãƒ³ãªã‚‰ã‚ªãƒ•ã€ã‚ªãƒ•ãªã‚‰ã‚ªãƒ³ï¼‰
            if (checkedItems[key]) {
                delete checkedItems[key];
            } else {
                checkedItems[key] = true;
            }
            
            // å¿˜ã‚Œãšãƒãƒ¼ãƒˆï¼ˆlocalStorageï¼‰ã«ä¿å­˜
            localStorage.setItem('kitchenCheckedItems', JSON.stringify(checkedItems));
            
            // ç”»é¢ã®è¦‹ãŸç›®ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ã€è¦ç´ ã‚’æ¢ã—ã¦ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘å¤–ã—ã™ã‚‹
            // ï¼ˆç”»é¢å…¨ä½“ã‚’å†æç”»ã—ãªãã¦ã‚‚ã€ã“ã“ã ã‘é€Ÿãåå¿œã•ã›ã‚‹ãŸã‚ï¼‰
            const elements = document.querySelectorAll(`[data-key="${key}"]`);
            elements.forEach(el => {
                if (checkedItems[key]) {
                    el.classList.add('checked');
                } else {
                    el.classList.remove('checked');
                }
            });
        };

        function updateDisplay(orderData) {
            const content = document.getElementById('content');
            const BATCH_WINDOW_MS = 5 * 1000; // 5ç§’è¨­å®šã®ã¾ã¾
            
            if (!orderData) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸ“‹ æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                        <p>iPadã§æ³¨æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            let allOrders = [];
            Object.entries(orderData).forEach(([roomName, roomData]) => {
                if (!roomData.courses) return;
                Object.entries(roomData.courses).forEach(([courseName, courseData]) => {
                    if (courseData.status !== 'order') return;
                    const timestamp = courseData.orderTimestamp || 0;
                    allOrders.push({
                        dishName: courseName,
                        roomName: roomName,
                        people: roomData.people || 2,
                        allergy: courseData.allergy || '',
                        wCount: courseData.wCount || 0,
                        staff: courseData.staff,
                        pressedTime: courseData.pressedTime,
                        timestamp: timestamp
                    });
                });
            });

            if (allOrders.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>âœ… å…¨ã¦ã®æ³¨æ–‡ãŒå‡¦ç†æ¸ˆã¿ã§ã™</h2>
                        <p>æ–°ã—ã„æ³¨æ–‡ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™</p>
                    </div>
                `;
                return;
            }

            const tempByDish = {};
            allOrders.forEach(order => {
                if (!tempByDish[order.dishName]) tempByDish[order.dishName] = [];
                tempByDish[order.dishName].push(order);
            });

            let displayBatches = [];
            Object.keys(tempByDish).forEach(dishName => {
                const orders = tempByDish[dishName];
                orders.sort((a, b) => a.timestamp - b.timestamp);
                let currentBatch = [];
                let batchStartTime = null;

                orders.forEach(order => {
                    if (currentBatch.length === 0) {
                        currentBatch.push(order);
                        batchStartTime = order.timestamp;
                    } else {
                        if (batchStartTime === 0 || (order.timestamp - batchStartTime <= BATCH_WINDOW_MS)) {
                            currentBatch.push(order);
                        } else {
                            displayBatches.push({
                                dishName: dishName,
                                orders: currentBatch,
                                startTime: batchStartTime
                            });
                            currentBatch = [order];
                            batchStartTime = order.timestamp;
                        }
                    }
                });
                if (currentBatch.length > 0) {
                    displayBatches.push({
                        dishName: dishName,
                        orders: currentBatch,
                        startTime: batchStartTime
                    });
                }
            });

            displayBatches.sort((a, b) => a.startTime - b.startTime);

            let html = '<div class="dish-grid">';
            
            displayBatches.forEach(batch => {
                const dishName = batch.dishName;
                const orders = batch.orders;
                const sortedOrders = sortRoomsByOrder(orders);
                const totalPeople = sortedOrders.reduce((sum, order) => sum + order.people, 0);
                const furigana = COURSE_FURIGANA[dishName] || '';
                
                let timeString = '';
                if (batch.startTime && batch.startTime > 0) {
                    const date = new Date(batch.startTime);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    timeString = `${hours}:${minutes}`; 
                }
                
                const isOldOrder = (Date.now() - batch.startTime > 300000) && batch.startTime !== 0;

                html += `
                    <div class="dish-card" style="${isOldOrder ? 'border-color: #e74c3c;' : ''}">
                        <div class="dish-header">
                            <div class="dish-name-container">
                                <div class="dish-name">${dishName}</div>
                                ${furigana ? `<div class="dish-furigana">${furigana}</div>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                                <div class="dish-total">${totalPeople}å</div>
                                ${timeString ? `<div style="font-size: 16px; font-weight: bold; color: #555;">ğŸ•’ ${timeString}</div>` : ''}
                            </div>
                        </div>
                        <div class="order-list">
                `;
                
                sortedOrders.forEach(order => {
                    // â˜…ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
                    const key = `${order.dishName}_${order.roomName}`;
                    const isChecked = checkedItems[key] ? 'checked' : '';

                    // â˜…ã‚¯ãƒªãƒƒã‚¯ã§ toggleCheck ã‚’å‘¼ã³å‡ºã™è¨­å®šã‚’è¿½åŠ 
                    // data-key ã¯ã€å¾Œã§ã‚¯ãƒ©ã‚¹ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ç›®å°ã§ã™
                    html += `<div class="order-item ${isChecked}" data-key="${key}" onclick="toggleCheck('${order.dishName}', '${order.roomName}')">`;
                    html += `<div class="check-mark">âœ”</div>`; // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯
                    html += `<div class="room-row">`;
                    html += `
                        <div class="room-name-left">
                            <span class="room-icon">ğŸ </span>
                            ${order.roomName}
                            <span class="people-count">${order.people}å</span>
                        </div>
                    `;
                    html += `<div class="tags-right">`;
                    if (order.wCount > 0) html += `<span class="detail-tag w-tag">ğŸ”¥ WÃ—${order.wCount}</span>`;
                    if (order.allergy) html += `<span class="detail-tag allergy-tag">${order.allergy}NG</span>`;
                    if (order.staff) html += `<span class="detail-tag staff-tag">ğŸ‘¤ ${order.staff}</span>`;
                    html += `</div>`; 
                    html += `</div>`; 
                    html += '</div>'; 
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function showError(title = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼', message = 'Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ') {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="empty-state">
                    <h2>âŒ ${title}</h2>
                    <p>${message}</p>
                    <p style="margin-top: 15px; font-size: 18px;">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>
                    <button onclick="location.reload()" style="
                        margin-top: 20px;
                        padding: 15px 30px;
                        font-size: 18px;
                        font-weight: bold;
                        background: #3498db;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
                    ">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
        }
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration.scope);
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                    setInterval(() => { registration.update(); }, 60 * 60 * 1000);
                })
                .catch((error) => {
                    console.log('Service Workerç™»éŒ²å¤±æ•—:', error);
                });
            
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>