<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚­ãƒƒãƒãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 25px;
            background: white;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .last-update {
            font-size: 20px;
            color: #7f8c8d;
        }

        .dish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .dish-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border: 3px solid #3498db;
        }

        .dish-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 4px solid #3498db;
        }

        .dish-name-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dish-name {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.2;
        }

        .dish-furigana {
            font-size: 32px;
            font-weight: bold;
            color: #7f8c8d;
            line-height: 1.2;
        }

        .dish-total {
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            background: #ffe6e6;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
            min-width: 120px;
            text-align: center;
        }

        .order-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .order-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 6px solid #3498db;
        }

        .room-names {
            font-size: 18px;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .room-name-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .room-icon {
            font-size: 16px;
        }

        .order-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .detail-tag {
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .allergy-tag {
            background: #fee;
            color: #c0392b;
            border: 3px solid #e74c3c;
        }

        .w-tag {
            background: #fff3cd;
            color: #856404;
            border: 3px solid #ffc107;
        }

        .time-tag {
            background: #d1ecf1;
            color: #0c5460;
            border: 3px solid #17a2b8;
        }

        .staff-tag {
            background: #d4edda;
            color: #155724;
            border: 3px solid #28a745;
        }

        .empty-state {
            text-align: center;
            padding: 80px 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .empty-state h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .empty-state p {
            font-size: 22px;
            color: #7f8c8d;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 768px) {
            .dish-grid {
                grid-template-columns: 1fr;
            }
            
            .dish-name {
                font-size: 30px;
            }
            
            .dish-furigana {
                font-size: 26px;
            }
            
            .dish-total {
                font-size: 38px;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }

        .loading-spinner {
            border: 6px solid #e0e0e0;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ³ ã‚­ãƒƒãƒãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤</h1>
        <div class="last-update" id="last-update">æ¥ç¶šä¸­...</div>
    </div>

    <div id="content">
        <div class="loading">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // æ–™ç†åã®ãµã‚ŠãŒãªå¯¾å¿œè¡¨
        const COURSE_FURIGANA = {
            "å¸ç‰©": "ã™ã„ã‚‚ã®",
            "æœèœç››ã‚Š": "ã‹ã•ã„ã‚‚ã‚Š",
            "è’¸ç‰©": "ã‚€ã—ã‚‚ã®",
            "æšç‰©": "ã‚ã’ã‚‚ã®",
            "ç…®ç‰©": "ã«ã‚‚ã®",
            "ã”é£¯": "ã”ã¯ã‚“",
            "ç”˜å‘³": "ã‹ã‚“ã¿",
            "ã™ãç„¼ã": "ã™ãã‚„ã",
            "ãƒ•ãƒ©ã‚¤": "ãµã‚‰ã„",
            "ã‚¹ãƒ†ãƒ¼ã‚­": "ã™ã¦ãƒ¼ã",
            "ã—ã‚ƒã¶ã—ã‚ƒã¶": "ã—ã‚ƒã¶ã—ã‚ƒã¶",
            "èŒ¶ç¢—è’¸ã—": "ã¡ã‚ƒã‚ã‚“ã‚€ã—",
            "ç‰›ãŸãŸã": "ãã‚…ã†ãŸãŸã",
            "ç„¼ç‰©": "ã‚„ãã‚‚ã®",
            "å°é‰¢": "ã“ã°ã¡"
        };

        // éƒ¨å±‹ã®è¡¨ç¤ºé †åºã‚’å®šç¾©
        const ROOM_ORDER = ["ã‚„ã¾ã¶ã", "ã¯ã", "ã¤ã°ã", "ããã‚‡ã†", "ãµã˜", "ã‚ã‚„ã‚"];

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAoyApbQzAlSYsM1MBDPZ68I5EaJ3M_yE8",
            authDomain: "restaurant-order-system-8855a.firebaseapp.com",
            databaseURL: "https://restaurant-order-system-8855a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "restaurant-order-system-8855a",
            storageBucket: "restaurant-order-system-8855a.firebasestorage.app",
            messagingSenderId: "695114713080",
            appId: "1:695114713080:web:de13ca2e7e448e92fb380d"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const ordersRef = ref(database, 'orders');

        // é€šçŸ¥éŸ³åˆ¶å¾¡ç”¨ã®å¤‰æ•°
        let lastNotificationTime = 0;
        const NOTIFICATION_INTERVAL = 5000; // 5ç§’
        let previousOrderStatuses = {};

        // é€šçŸ¥éŸ³ã‚’å†ç”Ÿï¼ˆWeb Audio APIã§ç”Ÿæˆï¼‰
        function playNotificationSound() {
            const now = Date.now();
            if (now - lastNotificationTime < NOTIFICATION_INTERVAL) {
                return; // 5ç§’ä»¥å†…ã¯é³´ã‚‰ã•ãªã„
            }
            lastNotificationTime = now;

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800; // 800Hzã®ãƒ“ãƒ¼ãƒ—éŸ³
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.error('é€šçŸ¥éŸ³ã®å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
        onValue(ordersRef, (snapshot) => {
            const orderData = snapshot.val();
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚’æ¤œå‡ºã—ã¦é€šçŸ¥éŸ³ã‚’é³´ã‚‰ã™
            checkForNewOrders(orderData);
            
            updateDisplay(orderData);
            updateLastUpdate();
        }, (error) => {
            console.error('Firebaseã‚¨ãƒ©ãƒ¼:', error);
            showError();
        });

        // æ–°ã—ã„ã€Œæ³¨ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¤œå‡º
        function checkForNewOrders(orderData) {
            if (!orderData) return;

            let hasNewOrder = false;

            Object.entries(orderData).forEach(([roomName, roomData]) => {
                if (!roomData.courses) return;

                Object.entries(roomData.courses).forEach(([courseName, courseData]) => {
                    const key = `${roomName}_${courseName}`;
                    const currentStatus = courseData.status;
                    const previousStatus = previousOrderStatuses[key];

                    // ä»¥å‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå­˜åœ¨ã—ã€ã‹ã¤ã€Œorderã€ä»¥å¤–ã‹ã‚‰ã€Œorderã€ã«å¤‰ã‚ã£ãŸå ´åˆ
                    if (previousStatus && previousStatus !== 'order' && currentStatus === 'order') {
                        hasNewOrder = true;
                    }

                    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜
                    previousOrderStatuses[key] = currentStatus;
                });
            });

            if (hasNewOrder) {
                playNotificationSound();
            }
        }

        // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
        function updateLastUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            document.getElementById('last-update').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;
        }

        // éƒ¨å±‹åã‚’ä¸¦ã³æ›¿ãˆã‚‹é–¢æ•°
        function sortRoomsByOrder(rooms) {
            return rooms.sort((a, b) => {
                const indexA = ROOM_ORDER.indexOf(a.roomName);
                const indexB = ROOM_ORDER.indexOf(b.roomName);
                
                // ä¸¡æ–¹ã¨ã‚‚å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é †åºã§æ¯”è¼ƒ
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                // ç‰‡æ–¹ã ã‘å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€å®šç¾©ã•ã‚Œã¦ã„ã‚‹æ–¹ã‚’å‰ã«
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                // ã©ã¡ã‚‰ã‚‚å®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åå‰ã§æ¯”è¼ƒ
                return a.roomName.localeCompare(b.roomName, 'ja');
            });
        }

        // ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’æ›´æ–°
        function updateDisplay(orderData) {
            const content = document.getElementById('content');
            
            if (!orderData) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>ğŸ“‹ æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                        <p>iPadã§æ³¨æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            // æ–™ç†ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const dishGroups = {};
            
            Object.entries(orderData).forEach(([roomName, roomData]) => {
                if (!roomData.courses) return;
                
                Object.entries(roomData.courses).forEach(([courseName, courseData]) => {
                    // ã€Œæ³¨ã€(order)ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ–™ç†ã®ã¿è¡¨ç¤º
                    if (courseData.status !== 'order') return;
                    
                    if (!dishGroups[courseName]) {
                        dishGroups[courseName] = [];
                    }
                    
                    // éƒ¨å±‹ã®è¨­å®šæƒ…å ±ã‚’å–å¾—(localStorageã‹ã‚‰)
                    const settings = JSON.parse(localStorage.getItem('orderSettings') || '{}');
                    let roomSettings = null;
                    
                    if (settings.rooms) {
                        roomSettings = settings.rooms.find(r => r.name === roomName);
                    }
                    if (!roomSettings && settings.customRooms) {
                        roomSettings = settings.customRooms.find(r => r.name === roomName);
                    }
                    
                    const people = roomSettings ? roomSettings.people : 2;
                    const allergy = roomSettings && roomSettings.allergies ? 
                        roomSettings.allergies[courseName] : null;
                    
                    dishGroups[courseName].push({
                        roomName: roomName,
                        people: people,
                        allergy: allergy,
                        wCount: courseData.wCount || 0,
                        time: courseData.time,
                        staff: courseData.staff,
                        pressedTime: courseData.pressedTime
                    });
                });
            });

            // è¡¨ç¤ºã‚’æ§‹ç¯‰
            if (Object.keys(dishGroups).length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>âœ… å…¨ã¦ã®æ³¨æ–‡ãŒå‡¦ç†æ¸ˆã¿ã§ã™</h2>
                        <p>æ–°ã—ã„æ³¨æ–‡ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="dish-grid">';
            
            Object.entries(dishGroups).forEach(([dishName, orders]) => {
                // éƒ¨å±‹ã®é †åºã§ã‚½ãƒ¼ãƒˆ
                const sortedOrders = sortRoomsByOrder(orders);
                const totalPeople = sortedOrders.reduce((sum, order) => sum + order.people, 0);
                
                // ãµã‚ŠãŒãªã‚’å–å¾—
                const furigana = COURSE_FURIGANA[dishName] || '';
                
                html += `
                    <div class="dish-card">
                        <div class="dish-header">
                            <div class="dish-name-container">
                                <div class="dish-name">${dishName}</div>
                                ${furigana ? `<div class="dish-furigana">${furigana}</div>` : ''}
                            </div>
                            <div class="dish-total">${totalPeople}å</div>
                        </div>
                        <div class="order-list">
                `;
                
                sortedOrders.forEach(order => {
                    html += `<div class="order-item">`;
                    
                    // éƒ¨å±‹åã®è¡¨ç¤ºï¼ˆäººæ•°ã¯è¡¨ç¤ºã—ãªã„ï¼‰
                    html += `
                        <div class="room-names">
                            <div class="room-name-item">
                                <span class="room-icon">ğŸ </span>
                                ${order.roomName}
                            </div>
                        </div>
                    `;
                    
                    // è©³ç´°ã‚¿ã‚°
                    const details = [];
                    
                    if (order.allergy) {
                        details.push(`
                            <span class="detail-tag allergy-tag">
                                âš ï¸ ${order.allergy}
                            </span>
                        `);
                    }
                    
                    if (order.wCount > 0) {
                        details.push(`
                            <span class="detail-tag w-tag">
                                ğŸ”¥ WÃ—${order.wCount}
                            </span>
                        `);
                    }
                    
                    if (order.time) {
                        details.push(`
                            <span class="detail-tag time-tag">
                                ğŸ• ${order.time}
                            </span>
                        `);
                    }
                    
                    if (order.staff) {
                        details.push(`
                            <span class="detail-tag staff-tag">
                                ğŸ‘¤ ${order.staff}
                            </span>
                        `);
                    }
                    
                    if (details.length > 0) {
                        html += `<div class="order-details">${details.join('')}</div>`;
                    }
                    
                    html += '</div>';
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="empty-state">
                    <h2>âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼</h2>
                    <p>Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                    <p style="margin-top: 15px; font-size: 18px;">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>
                </div>
            `;
        }
    </script>
</body>
</html>
